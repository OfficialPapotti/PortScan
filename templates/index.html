<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Scanner de Banner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script>
    let tempoInicial = null;

    async function atualizarResultados() {
      try {
        const response = await fetch("/resultados");
        const data = await response.json();
        const lista = document.getElementById("resultados");
        lista.innerHTML = "";

        const grupos = {};
        data.resultados.forEach(item => {
          let tipo = "Desconhecido";
          if (item.includes("MySQL:")) tipo = "MySQL";
          else if (item.includes("PostgreSQL:")) tipo = "PostgreSQL";
          else if (item.includes("Redis:")) tipo = "Redis";
          else if (item.includes("MongoDB")) tipo = "MongoDB";
          else if (item.includes("Memcached")) tipo = "Memcached";
          else if (item.includes("HTTP:")) tipo = "HTTP";
          else if (item.toLowerCase().includes("timeout")) tipo = "Timeout";
          else if (item.toLowerCase().includes("recusada") || item.toLowerCase().includes("conexao recusada")) tipo = "Conexão recusada";
          else if (item.toLowerCase().includes("erro")) tipo = "Erro";

          if (!grupos[tipo]) grupos[tipo] = [];
          grupos[tipo].push(item);
        });

        const ordenados = Object.keys(grupos).sort();
        ordenados.forEach((tipo, idx) => {
          const wrapper = document.createElement("li");
          wrapper.className = "list-group-item";

          const header = document.createElement("div");
          header.className = "d-flex justify-content-between align-items-center";

          const title = document.createElement("span");
          title.textContent = `${tipo} (${grupos[tipo].length})`;

          const btn = document.createElement("button");
          btn.className = "btn btn-sm btn-outline-secondary";
          btn.textContent = "⯈";
          btn.setAttribute("data-bs-toggle", "collapse");
          btn.setAttribute("data-bs-target", `#group-${idx}`);
          btn.setAttribute("aria-expanded", "false");
          btn.setAttribute("aria-controls", `group-${idx}`);
          btn.onclick = () => {
            btn.textContent = btn.textContent === "⯈" ? "⯆" : "⯈";
          };

          header.appendChild(title);
          header.appendChild(btn);
          wrapper.appendChild(header);

          const collapse = document.createElement("div");
          collapse.className = "collapse mt-2 overflow-auto";
          collapse.id = `group-${idx}`;
          collapse.style.maxHeight = "300px";

          grupos[tipo].forEach(linha => {
            const pre = document.createElement("pre");
            pre.className = "bg-light border p-2 rounded small";
            pre.textContent = linha;
            collapse.appendChild(pre);
          });

          wrapper.appendChild(collapse);
          lista.appendChild(wrapper);
        });

        const loader = document.getElementById("loader");
        const progresso = document.getElementById("progresso");
        const cancelar = document.getElementById("cancelar");
        const eta = document.getElementById("eta");
        const exportar = document.getElementById("exportar");

        if (data.em_andamento) {
          if (!tempoInicial) tempoInicial = Date.now();

          const percent = data.total ? Math.floor((data.concluido / data.total) * 100) : 0;
          progresso.style.width = percent + "%";
          progresso.innerText = percent + "%";

          const tempoAgora = Date.now();
          const tempoPassado = (tempoAgora - tempoInicial) / 1000;
          const tempoEstimadoTotal = data.concluido ? (tempoPassado * data.total / data.concluido) : 0;
          const tempoRestante = tempoEstimadoTotal - tempoPassado;
          eta.innerText = "Tempo estimado restante: " + Math.max(0, tempoRestante.toFixed(1)) + "s";

          loader.style.display = "block";
          cancelar.style.display = "inline-block";
          exportar.style.display = "none";

          setTimeout(atualizarResultados, 1500);
        } else {
          loader.style.display = "none";
          cancelar.style.display = "none";
          exportar.style.display = "block";
          tempoInicial = null;
        }
      } catch (e) {
        alert("Erro ao obter resultados.");
      }
    }

    async function iniciarScan() {
      const ip_range = document.getElementById("ip_range").value.trim();
      const ports = document.getElementById("ports").value.trim();

      if (!ip_range || !ports) {
        alert("Preencha faixa de IPs e portas.");
        return;
      }

      const formData = new FormData();
      formData.append("ip_range", ip_range);
      formData.append("ports", ports);

      const resp = await fetch("/scan", {
        method: "POST",
        body: formData
      });

      if (resp.ok) {
        atualizarResultados();
      } else {
        alert("Falha ao iniciar scan.");
      }
    }

    async function cancelarScan() {
      await fetch("/cancelar", { method: "POST" });
    }

    async function exportarJSONLComFiltros() {
      const svc = document.getElementById("filtro_service").value;
      const pais = document.getElementById("filtro_country").value;
      let url = "/exportar-jsonl";
      const params = [];
      if (svc) params.push(`service=${encodeURIComponent(svc)}`);
      if (pais) params.push(`country=${encodeURIComponent(pais)}`);
      if (params.length) url += "?" + params.join("&");
      window.location.href = url;
    }

    async function consultarCacheFiltrado() {
      const svc = document.getElementById("filtro_service").value;
      const pais = document.getElementById("filtro_country").value;
      let url = "/consulta";
      const params = [];
      if (svc) params.push(`service=${encodeURIComponent(svc)}`);
      if (pais) params.push(`country=${encodeURIComponent(pais)}`);
      if (params.length) url += "?" + params.join("&");

      const div = document.getElementById("resultados_consulta");
      div.innerHTML = "Carregando...";
      const res = await fetch(url);
      const dados = await res.json();
      div.innerHTML = `<pre class='bg-light border p-3 small'>${JSON.stringify(dados, null, 2)}</pre>`;
    }

    window.onload = atualizarResultados;
  </script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h1 class="mb-4">Scanner de Banner</h1>

    <div class="mb-3">
      <label class="form-label">Faixa de IPs</label>
      <input id="ip_range" name="ip_range" class="form-control" placeholder="Ex: 192.168.0.0/24" required>
    </div>

    <div class="mb-3">
      <label class="form-label">Portas</label>
      <input id="ports" name="ports" class="form-control" placeholder="Ex: 3306,5432,6379,27017" required>
    </div>

    <div class="d-flex gap-2 align-items-end flex-wrap">
      <button type="button" class="btn btn-primary" onclick="iniciarScan()">Iniciar Scan</button>
    </div>

    <div id="loader" class="mb-4" style="display: none;">
      <div class="progress mb-2">
        <div id="progresso" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%">0%</div>
      </div>
      <p id="eta" class="text-muted border p-2 rounded">Estimando tempo...</p>
      <button id="cancelar" class="btn btn-danger btn-sm" onclick="cancelarScan()" style="display: none;">Cancelar Scan</button>
    </div>

    <h3>Resultados:</h3>
    <ul id="resultados" class="list-group mb-3"></ul>

    <form method="GET" action="/exportar">
      <button id="exportar" class="btn btn-success" style="display: none;">Exportar CSV</button>
    </form>

    <hr class="my-4">
    <h4>Filtros e consultas:</h4>
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Serviço</label>
        <input type="text" id="filtro_service" class="form-control" placeholder="Ex: Redis">
      </div>
      <div class="col-md-3">
        <label class="form-label">País</label>
        <input type="text" id="filtro_country" class="form-control" placeholder="Ex: BR">
      </div>
      <div class="col-auto">
        <button type="button" class="btn btn-outline-secondary" onclick="exportarJSONLComFiltros()">Exportar JSONL</button>
        <button type="button" class="btn btn-outline-primary" onclick="consultarCacheFiltrado()">Consultar cache filtrado</button>
      </div>
    </div>
    <div id="resultados_consulta" class="mt-4"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
